name: GitHub Actions Demo
on: [push]
jobs:
  DeployCode:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ID }}
          aws-secret-access-key: ${{ secrets.AWS_KEY }}
          aws-region: ${{ secrets.REGION }}
      - id: files
        uses: jitterbit/get-changed-files@v1
        with:
          format: 'json'
      - run: |
          set -eu
          folders=""
          files=`jq -r '.[]' <<<'${{ steps.files.outputs.all }}'`

          for file in ${files[@]}; do
            folders="$folders $(dirname $file)"
          done
          folders="$folders" | tr " " "\n" | sort | uniq | tr "\n" " "
          cd bin
          for folder in $folders; do
              if [[ $folder == *-udfs/* ]]; then
                IFS="/" read -ra PARTS <<< "$folder"
                ./deployFunction.sh ${PARTS[0]} "${PARTS[1]}" ${{ secrets.S3_LOC }} ${{ secrets.IAM_ROLE }} ${{ secrets.CLUSTER }} ${{ secrets.DB }} ${{ secrets.USER }} ${{ secrets.SCHEMA }}
                ./testFunction.sh ${PARTS[0]} "${PARTS[1]}" ${{ secrets.CLUSTER }} ${{ secrets.DB }} ${{ secrets.USER }} ${{ secrets.SCHEMA }}
              else
                echo Ignoring: $folder
              fi
          done
